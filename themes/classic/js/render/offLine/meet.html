<!DOCTYPE html>

<html> 
    <head>
        <script type="text/javascript">
            if(sessionStorage.getItem("authorization") == null  || sessionStorage.getItem("authorization") == 'false'){
                location.href = 'login.html';
            }
        </script>
        <!-- SEMPRE MANTER ATUALIZADO COM O LAYOUT DO RENDER !!!  -->
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width; initial-scale=1.2; maximum-scale=1.2; target-densitydpi=medium-dpi; user-scalable=no" />
        <link rel="stylesheet" type="text/css" href="css/reset.css" />
        <link rel="stylesheet" type="text/css" href="css/print.css" media="print" />
        <link rel="stylesheet" type="text/css" href="css/render/render.css">
        <link rel="stylesheet" type="text/css" href="css/reset.css">
        <link rel="stylesheet" type="text/css" href="css/render/global.css">
        <link rel="stylesheet" type="text/css" href="css/render/meet.css">
        <link rel="stylesheet" type="text/css" href="css/render/fonts.css">
        <!---[if lt IE 8]>
        <link rel="stylesheet" type="text/css" href="<?php echo Yii::app()->theme->baseUrl; ?>/css/ie.css" media="screen, projection" />
        <![endif]-->
        <script src="js/jquery/jquery-1.7.2.js"></script>
        <script src="js/jquery/jquery.ui.core.js"></script>
        <script src="js/jquery/jquery.ui.widget.js"></script>
        <script src="js/jquery/jquery.ui.mouse.js"></script>
        <script src="js/jquery/jquery.ui.touch-punch.min.js"></script>
        <script src="js/jquery/jquery.ui.draggable.js"></script>
        <script src="js/jquery/jquery.ui.droppable.js"></script>
        <script type="text/javascript" src="js/render/meet.js"></script>
        <script type="text/javascript" src="js/render/domcobject.js"></script>
        <script type="text/javascript" src="js/jquery.shuffle.js"></script>
        <!-- Abrir Script do renderDB --> 
        <script type="text/javascript" src="db/renderDB.js"></script>
        <script>
            
            function isset(variable) {
                return (variable !== undefined && variable !== null);
            }

            $(document).ready(function(){
                if (window.openDatabase) {
                    console.log("Suporta BD-HTML5");
                }

                //Iniciar Encontro
                var personage = '';
                var idActor = '';
                var unityIdActor = '';
                //===========================================
                var unityfather = ''; 
                var org = ''; 
                var classe = ''; 
        
                //var unityfather_name = ''; 
                var org_name = ''; 
                var classe_name = ''; 
          
                //Verificar se existe um aluno selecionado pelo tutor
                //Ou se foi o próprio aluno que realizou login
                var id_actor = isset(sessionStorage.getItem('id_actor')) ?
                    sessionStorage.getItem('id_actor'): sessionStorage.getItem('login_id_actor');
                var name_actor = isset(sessionStorage.getItem('name_actor')) ?
                    sessionStorage.getItem('name_actor'): sessionStorage.getItem('login_name_actor');
                //Personagem de quem fez o login
                var login_personage_name = sessionStorage.getItem('login_personage_name');
                
                //Selecionar o Bloco de Atividades
                var discipline_id = sessionStorage.getItem('id_discipline');
                var block_id;
                switch(discipline_id){
                    case '1':block_id='4';break; //Linguagem
                    case '2':block_id='2';break; //Matemática   
                }
                
                var options = {
                    org: [org,org_name],
                    classe: [classe,classe_name],
                    actor: [id_actor,name_actor,login_personage_name],
                    id_discipline: discipline_id,
                    cobject_block_id:block_id
                };
         
                //Passar parâmetro do tipo do Encontro
                var newMeet = new Meet(options);
        
                //$('#head_meet').append(newMeet.headMeet());
                
                var cobjectsFromBlock = null;
                //Obter todos os Cobject deste Bloco
                var getcobjectsFromBlock =  newMeet.DB_synapse.getCobjectsFromBlock(block_id, function(objectsThisBlock){
                  
                    //count do número de objetos
                    var num_objects = 0;
                    $.each(objectsThisBlock, function(){
                        num_objects++;
                    });
                    
                   
                    $.each(objectsThisBlock, function(idx, object){
                        //Para cada Cobject Cria sua Dom
                        newMeet.DB_synapse.getCobject(object, function(json_cobject){
                            var dump = new DomCobject(json_cobject,idx);
                            //Adicionar o domCobjets no Encontro 'Meet'
                            newMeet.pushDomCobjects(dump);
                            //Chamar função para inserir nome html
                            if(idx == num_objects-1){
                                $('#render_canvas').html(newMeet.domCobjectBuildAll());
                                //Inicia os eventos somente após a inclusão do html na dom
                                newMeet.beginEvents();
                                // Render Ready! 
                                newMeet.countTime($('.info-time .info-text'));
                               // $('#begin_activity').trigger('click');
                             
                            }
                            
                        });
                    });
    
                    
                });
                
                
                $(document).on('click','.soundIconPause',(function() {
                    var playing = false;
                    var li = $(this).parent();
                    var span = li.children('span');
                    var img = $(this);
                    var audio = span.children()[0];
                    
                    if(playing){
                        audio.pause();
                        audio.currentTime=0;
                        img.attr('src', "img/icons/play.png");
                        playing = false;
                    }
                    else{
                        audio.play();
                        img.attr('src', "img/icons/stop.png");
                        playing = true;
                    }

                    audio.addEventListener("ended", function(){
                        img.attr('src', "img/icons/play.png");
                        playing = true;
                    });

                }));
                //Atualizar O painel do render
                $('.info.info-name').html('<p>'+newMeet.actor_name+'</p>');
                $('.info.info-hits .info-text').html(newMeet.peformance_qtd_correct);
                $('.info.info-erros .info-text').html(newMeet.peformance_qtd_wrong); 

                //Mostrar/Ocultar barra de informações
                $('#info-button').click(function() {
                    if ($('#head_meet').is(':visible')) {
                        $('#head_meet').hide();
                        $('#info-button').css('left','0');
                        $('#info-button').removeClass('menu-close');
                        $('#info-button').addClass('menu-open');
                    } else {
                        $('#head_meet').show();
                        $('#info-button').css('left','156px');
                        $('#info-button').removeClass('menu-open');
                        $('#info-button').addClass('menu-close');
                    }
                });
                
                // Encerrar atendimento
                $(".info-exit").click(function(){
                    $("#finalize-message").show();
                });
                $("#finalize-icon").click(function(){
                    newMeet.finalizeMeet();
                });
                $("#close-icon").click(function(){
                    $("#finalize-message").hide();
                });

            });
    
        </script>
        <title>Render</title>
    </head>
    <body id="synapse" ondragstart='return true'>

        <!-- Barra de informações -->
        <div id="head_meet">
            <div class="info info-name">

            </div>
            <div class="info info-time">
                <img class="info-icon" src="img/icons/clock.png">
                <p class="info-text"></p>
                <div class="clear"></div>
            </div>
            <div class="info info-hits">
                <img class="info-icon" src="img/icons/hit.png">
                <p class="info-text"></p>
                <div class="clear"></div>
            </div>
            <div class="info info-erros">
                <img class="info-icon" src="img/icons/error.png">
                <p class="info-text"></p>
                <div class="clear"></div>
            </div>
            <a class="info-exit" href="#">
                <img class="info-icon" src="img/icons/exit.png">
                <p class="info-text">encerrar atendimento</p>
                <div class="clear"></div>
            </a>
        </div>

        <div id="info-button" class="menu-open">

        </div>

        <div id="message"> 
        </div>

        <div id="render_canvas">
        </div>

        <div class="game">
            <div class="level">
                <img class="score-icon" src="img/icons/level.png">
                <p id="level" class="score-number">0</p>
            </div>
            <div class="points">
                <img class="score-icon" src="img/icons/points.png">
                <p id="points" class="score-number">0</p>
            </div>
        </div>

        <!-- Acerto -->
        <div id="hit-message" class="modal_message overlay">
            <div class="message-container success">
                <img class="ok message-icon" src="img/icons/hit.png">
                <p class="message">Parabéns!<br>Você acertou!! \o/</p>
                <button class="message-button">OK</button>
            </div>
        </div>

        <!-- Erro -->
        <div id="error-message" class="modal_message overlay">
            <div class="message-container error">
                <img class="ok message-icon" src="img/icons/error.png">
                <p class="message">Que peninha<br/>você errou :/</p>
                <button class="message-button">OK</button>
            </div>
        </div>

        <!-- Encerrar atividade -->
        <div id="finalize-message" class="overlay">
            <div class="message-container exit">
                <p class="message">Deseja encerrar<br>o atendimento desse aluno?</p>
                <img id="finalize-icon" class="message-icon" src="img/icons/hit.png">
                <img id="close-icon" class="message-icon" src="img/icons/error.png">
            </div>
        </div>

        <!-- Avanço de Nível -->
        <div id="nextLevel-message" class="nextLevel-message modal_message overlay">
            <div class="message-container success">
                <img class="ok message-icon" src="img/icons/raio_telapassagem.png">
                <p class="message">Parabéns!<br>Você passou de nível!</p>
                <button class="message-button">OK</button>
            </div>
        </div>
        
        <!-- Avanço do Último Nível -->
        <div id="finishLevel-message" class="nextLevel-message modal_message overlay">
            <div class="message-container success">
                <img class="ok message-icon" src="img/icons/raio_telapassagem.png">
                <p class="message">Parabéns!<br>Você passou de nível!</p>
                <button class="message-button">OK</button>
            </div>
        </div>
        
    </body>
</html>


<html> 
    <head>
        <!-- SEMPRE MANTER ATUALIZADO COM O LAYOUT DO RENDER !!!  -->
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=0.5, maximum-scale=0.5, user-scalable=no" />
        <link rel="stylesheet" type="text/css" href="css/reset.css" media="screen, projection" />
        <link rel="stylesheet" type="text/css" href="css/render/global.css">
        <link rel="stylesheet" type="text/css" href="css/render/admin.css">
        <link rel="stylesheet" type="text/css" href="css/render/fonts.css">
        <link rel="stylesheet" type="text/css" href="css/print.css" media="print" />
        <!---[if lt IE 8]>
        <link rel="stylesheet" type="text/css" href="<?php echo Yii::app()->theme->baseUrl; ?>/css/ie.css" media="screen, projection" />
        <![endif]-->
        <script src="js/jquery/jquery-1.7.2.js"></script>
        <script src="js/jquery/jquery.ui.core.js"></script>
        <script src="js/jquery/jquery.ui.widget.js"></script>
        <script src="js/jquery/jquery.ui.mouse.js"></script>
        <script src="js/jquery/jquery.ui.draggable.js"></script>
        <script src="js/jquery/jquery.ui.droppable.js"></script>

        <!-- JQUERY FOR MOBILE-->
        <script type="text/javascript" src="js/jquery/mobile/jquery.mobile-1.4.3/jquery.mobile-1.4.3.js"></script>
        <!-- ======= -->

        <script type="text/javascript" src="js/render/meet.js"></script>
        <script type="text/javascript" src="js/render/domcobject.js"></script>
        <script type="text/javascript" src="js/jquery.shuffle.js"></script>
        <!-- Abrir Script do renderDB --> 
        <script type="text/javascript" src="db/renderDB.js"></script>
        <script type="text/javascript" src="data/json/renderDataLin.js"></script>
        <script type="text/javascript" src="data/json/renderDataMat.js"></script>
        <script>

            function existInArray(array, id) {
                for (var i in array) {
                    if (array[i].id == id) {
                        return true;
                    }
                }
                return false;
            }


            $(document).ready(function () {

                //Somente para retirar o 'loading' que o jquery cria automaticamente
                $(".ui-loader.ui-corner-all.ui-body-a.ui-loader-default").css('display', 'none');

                //Criar Objeto para Manipulação do Banco
                var db = new DB();

                function deleteDatabase() {
                    indexedDB.deleteDatabase("synapseDB");
                }

                function buildAllSchemas() {
                    //1° Criar
                    db.openDBuild(true, dataImportFunction);
                }

                function dataImportFunction() {
                    if(dataJsonLin !== undefined && dataJsonLin !== null){
                        //Importar Linguagem
                        importGeneral(dataJsonLin);
                    }
                    if(dataJsonMat !== undefined && dataJsonMat !== null){
                        //Importar Matemática
                        importGeneral(dataJsonMat);
                    }
                }

                function importGeneral(dataJson) {
                    var schools = new Array();
                    var unitys = new Array();
                    var actors = new Array();

                    //Percorrer todos objetos existentes no ActorsOwnUnity
                    $.each(dataJson.ActorsOwnUnity, function (idx, object) {
                        var tempSchool = {};
                        tempSchool.id = object.school_id;
                        tempSchool.name = object.school_name;
                        if (!existInArray(schools, tempSchool.id)) {
                            schools.push(tempSchool);
                        }
                        
                        var tempUnity = {};
                        tempUnity.id = object.unity_id;
                        //FK para a school
                        tempUnity.school_id = object.school_id;
                        tempUnity.father_id = object.unity_father;
                        tempUnity.name = object.unity_name;
                        tempUnity.organization_id = object.unity_organization_id;
                        if (!existInArray(unitys, tempUnity.id)) {
                            unitys.push(tempUnity);
                        }
                        var tempActor = {};
                        tempActor.id = object.id;
                        tempActor.login = object.login;
                        tempActor.name = object.name;
                        tempActor.password = object.password;
                        tempActor.personage_name = object.personage;
                        //Chave Estrageira para a sua unidade
                        tempActor.unity_id = object.unity_id;
                        if (!existInArray(actors, tempActor.id)) {
                            actors.push(tempActor);
                        }
                    });
                    var disciplines = dataJson.Disciplines;
                    var cobjectblock = dataJson.CobjectBlock;
                    var cobject_cobjectblocks = dataJson.Cobject_cobjectBlocks;
                    var cobjects = dataJson.Cobjects;
                    
                    
                    //2° Importar
                    db.importAllDataRender(schools, unitys, actors, disciplines, cobjectblock
                            , cobject_cobjectblocks, cobjects);

                }

                function deleteDatabase() {
                    indexedDB.deleteDatabase("synapseDB");
                }


                $('#export').bind('tap', function () {
                    db.exportPerformance_actor();
                });

                $('#installAll').on('tap', function () {
                    deleteDatabase();
                    buildAllSchemas();
                });

                $('#deleteAllDB').bind('tap', function () {
                    deleteDatabase();
                });


                $('#buildAllSchemas').bind('tap', function () {
                    buildAllSchemas();
                });

                $('#importLinguagem').bind('tap', function () {
                     importGeneral(dataJsonLin);
                });


                $('#importMatematica').bind('tap', function () {
                    importGeneral(dataJsonMat);
                });

                $('#back').bind('tap', function () {
                    location.href = "index.html";
                });
            });

        </script>
        <title>Import</title>
        <link rel="icon" type="image/png" href="icons/icon-48.png" /> 
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body>
        <section id="export-form">
            <div id="export_data">
                <button class="export-button buttons" type="button" id="export"> Exportar Performance</button>  
            </div>
        </section>    

        <section id="import-form">
            <div id="import_data">

                <!--
                <button class="import-button buttons" type="button" id="deleteAllDB"> Limpar Banco </button>  
                <button class="import-button buttons" type="button" id="buildAllSchemas" name="buildAllSchemas" >Construir Esquemas</button>
                <button class="import-button buttons" type="button" id="importLinguagem" name="importLinguagem" >Importar Dados - 1º Ano LINGUAGEM</button>
                <button class="import-button buttons" type="button" id="importMatematica" name="importMatematica" >Importar Dados - 1º Ano MATEMÁTICA</button>
                -->
                <button class="import-button buttons" type="button" id="installAll" name="installAll" >Instalar</button>
                <button class="back-button buttons" type="button" id="back" name="back" >Voltar</button>
            </div>
        </section>
    </body>
</html>


